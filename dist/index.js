var b=class extends AudioContext{volume;constructor(){super({sampleRate:36e3}),this.volume=this.createGain(),this.volume.gain.setValueAtTime(.5,this.currentTime)}receiveAudio(a){let t=this.createBuffer(2,2048,36e3);for(let m=0;m<2048;m++)t.getChannelData(0)[m]=a[m],t.getChannelData(1)[m]=a[m+2048];let c=this.createBufferSource();c.buffer=t,c.connect(this.volume),this.volume.connect(this.destination),c.start()}setVolume(a){this.volume.gain.setValueAtTime(a/100,this.currentTime)}};async function st(v={}){var a,t=v,c=!0,m=!1,U=[],_="./this.program",S=import.meta.url,W="";function re(e){return t.locateFile?t.locateFile(e,W):W+e}var T,k;if(c||m){try{W=new URL(".",S).href}catch{}T=async e=>{var r=await fetch(e,{credentials:"same-origin"});if(r.ok)return r.arrayBuffer();throw new Error(r.status+" : "+r.url)}}var s=console.log.bind(console),p=console.error.bind(console),w,B=!1,C,D,M,L,R,ne,ae,ie,P,oe,se,ue,fe,x=!1;function z(){var e=M.buffer;t.HEAP8=L=new Int8Array(e),t.HEAP16=ne=new Int16Array(e),t.HEAPU8=R=new Uint8Array(e),t.HEAPU16=ae=new Uint16Array(e),t.HEAP32=ie=new Int32Array(e),t.HEAPU32=P=new Uint32Array(e),t.HEAPF32=oe=new Float32Array(e),t.HEAPF64=se=new Float64Array(e),ue=new BigInt64Array(e),fe=new BigUint64Array(e)}function le(){if(t.preRun)for(typeof t.preRun=="function"&&(t.preRun=[t.preRun]);t.preRun.length;)we(t.preRun.shift());V(N)}function ce(){x=!0,d.e()}function me(){if(t.postRun)for(typeof t.postRun=="function"&&(t.postRun=[t.postRun]);t.postRun.length;)Se(t.postRun.shift());V(K)}function ve(e){t.onAbort?.(e),e="Aborted("+e+")",p(e),B=!0,e+=". Build with -sASSERTIONS for more info.";var r=new WebAssembly.RuntimeError(e);throw D?.(r),r}var I;function he(){return t.locateFile?re("snes9x_2005.wasm"):new URL("snes9x_2005.wasm",import.meta.url).href}function ye(e){if(e==I&&w)return new Uint8Array(w);if(k)return k(e);throw"both async and sync fetching of the wasm failed"}async function Ae(e){if(!w)try{var r=await T(e);return new Uint8Array(r)}catch{}return ye(e)}async function ge(e,r){try{var n=await Ae(e),i=await WebAssembly.instantiate(n,r);return i}catch(f){p(`failed to asynchronously prepare wasm: ${f}`),ve(f)}}async function pe(e,r,n){if(!e)try{var i=fetch(r,{credentials:"same-origin"}),f=await WebAssembly.instantiateStreaming(i,n);return f}catch(u){p(`wasm streaming compile failed: ${u}`),p("falling back to ArrayBuffer instantiation")}return ge(r,n)}function de(){return{a:at}}async function _e(){function e(u,o){return d=u.exports,M=d.d,z(),nt(d),d}function r(u){return e(u.instance)}var n=de();if(t.instantiateWasm)return new Promise((u,o)=>{t.instantiateWasm(n,(l,y)=>{u(e(l,y))})});I??=he();var i=await pe(w,I,n),f=r(i);return f}class ht{name="ExitStatus";constructor(r){this.message=`Program terminated with exit(${r})`,this.status=r}}var V=e=>{for(;e.length>0;)e.shift()(t)},K=[],Se=e=>K.push(e),N=[],we=e=>N.push(e),Re=!0,Ee=e=>X(e),Me=()=>j(),Pe=()=>Date.now(),be=()=>2147483648,Ue=(e,r)=>Math.ceil(e/r)*r,We=e=>{var r=M.buffer.byteLength,n=(e-r+65535)/65536|0;try{return M.grow(n),z(),1}catch{}},Ie=e=>{var r=R.length;e>>>=0;var n=be();if(e>n)return!1;for(var i=1;i<=4;i*=2){var f=r*(1+.2/i);f=Math.min(f,e+100663296);var u=Math.min(n,Ue(Math.max(e,f),65536)),o=We(u);if(o)return!0}return!1},He=[null,[],[]],q=typeof TextDecoder<"u"?new TextDecoder:void 0,Fe=(e,r,n,i)=>{var f=r+n;if(i)return f;for(;e[r]&&!(r>=f);)++r;return r},$=(e,r=0,n,i)=>{var f=Fe(e,r,n,i);if(f-r>16&&e.buffer&&q)return q.decode(e.subarray(r,f));for(var u="";r<f;){var o=e[r++];if(!(o&128)){u+=String.fromCharCode(o);continue}var l=e[r++]&63;if((o&224)==192){u+=String.fromCharCode((o&31)<<6|l);continue}var y=e[r++]&63;if((o&240)==224?o=(o&15)<<12|l<<6|y:o=(o&7)<<18|l<<12|y<<6|e[r++]&63,o<65536)u+=String.fromCharCode(o);else{var A=o-65536;u+=String.fromCharCode(55296|A>>10,56320|A&1023)}}return u},Te=(e,r)=>{var n=He[e];r===0||r===10?((e===1?s:p)($(n)),n.length=0):n.push(r)},ke=(e,r,n)=>e?$(R,e,r,n):"",Be=(e,r,n,i)=>{for(var f=0,u=0;u<n;u++){var o=P[r>>2],l=P[r+4>>2];r+=8;for(var y=0;y<l;y++)Te(e,R[o+y]);f+=l}return P[i>>2]=f,0},G=e=>{var r=t["_"+e];return r},Ce=(e,r)=>{L.set(e,r)},De=e=>{for(var r=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i<=127?r++:i<=2047?r+=2:i>=55296&&i<=57343?(r+=4,++n):r+=3}return r},Le=(e,r,n,i)=>{if(!(i>0))return 0;for(var f=n,u=n+i-1,o=0;o<e.length;++o){var l=e.codePointAt(o);if(l<=127){if(n>=u)break;r[n++]=l}else if(l<=2047){if(n+1>=u)break;r[n++]=192|l>>6,r[n++]=128|l&63}else if(l<=65535){if(n+2>=u)break;r[n++]=224|l>>12,r[n++]=128|l>>6&63,r[n++]=128|l&63}else{if(n+3>=u)break;r[n++]=240|l>>18,r[n++]=128|l>>12&63,r[n++]=128|l>>6&63,r[n++]=128|l&63,o++}}return r[n]=0,n-f},xe=(e,r,n)=>Le(e,R,r,n),J=e=>Y(e),ze=e=>{var r=De(e)+1,n=J(r);return xe(e,n,r),n},Ve=(e,r,n,i,f)=>{var u={string:h=>{var E=0;return h!=null&&h!==0&&(E=ze(h)),E},array:h=>{var E=J(h.length);return Ce(h,E),E}};function o(h){return r==="string"?ke(h):r==="boolean"?!!h:h}var l=G(e),y=[],A=0;if(i)for(var g=0;g<i.length;g++){var Z=u[n[g]];Z?(A===0&&(A=Me()),y[g]=Z(i[g])):y[g]=i[g]}var H=l(...y);function ot(h){return A!==0&&Ee(A),o(h)}return H=ot(H),H},Ke=(e,r,n,i)=>{var f=!n||n.every(o=>o==="number"||o==="boolean"),u=r!=="string";return u&&f&&!i?G(e):(...o)=>Ve(e,r,n,o,i)};if(t.noExitRuntime&&(Re=t.noExitRuntime),t.print&&(s=t.print),t.printErr&&(p=t.printErr),t.wasmBinary&&(w=t.wasmBinary),t.arguments&&(U=t.arguments),t.thisProgram&&(_=t.thisProgram),t.preInit)for(typeof t.preInit=="function"&&(t.preInit=[t.preInit]);t.preInit.length>0;)t.preInit.shift()();t.cwrap=Ke;var Ne,qe,$e,Ge,Je,Xe,Ye,je,Ze,Qe,Oe,et,tt,rt,X,Y,j;function nt(e){t._setJoypadInput=Ne=e.f,t._my_malloc=qe=e.g,t._my_free=$e=e.h,t._startWithRom=Ge=e.i,t._mainLoop=Je=e.j,t._getScreenBuffer=Xe=e.k,t._getSoundBuffer=Ye=e.l,t._saveSramRequest=je=e.m,t._getSaveSramSize=Ze=e.n,t._getSaveSram=Qe=e.o,t._loadSram=Oe=e.p,t._getStateSaveSize=et=e.q,t._saveState=tt=e.r,t._loadState=rt=e.s,X=e.t,Y=e.u,j=e.v}var at={c:Pe,b:Ie,a:Be};function it(){le();function e(){t.calledRun=!0,!B&&(ce(),C?.(t),t.onRuntimeInitialized?.(),me())}t.setStatus?(t.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>t.setStatus(""),1),e()},1)):e()}var d;return d=await _e(),it(),x?a=t:a=new Promise((e,r)=>{C=e,D=r}),a}var Q=st;var O=36e3,ee=917504,ut=512,ft=448,lt={wasmPath:"snes9x_2005.wasm",audioOn:!0},F=class v{cvs;ctx;WASM;emulationRunning=!0;audioNode;audioOn=!0;keyInput=0;setUint8ArrayToCMemory(a){var t=this.WASM._my_malloc(a.length);return this.WASM.HEAP8.set(a,t),t}static async create(a,t,c){let{wasmPath:m,audioOn:U}={...lt,...c};try{let _=await Q({locateFile(){return m.startsWith("http")?m:new URL(m,import.meta.url).href}}),S=new v(t,_);return S.audioOn=U,S.initEmulation(a),S}catch(_){throw new Error(`Snes9x_2005-WASM:: Initialization error.
        Did you supply a wasm blob https://github.com/HenryLF/snes9x2005-wasm ? 
        ${_}`)}}constructor(a,t){this.cvs=a,this.WASM=t,this.initCanvas(),this.audioNode=new b;let c=a.getContext("2d");if(!c)throw new Error("Snes9x_2005-WASM:: Invalid canvas element, unable to get rendering context.");this.ctx=c}initEmulation(a){let t=this.setUint8ArrayToCMemory(a);this.WASM._startWithRom(t,a.length,O),this.WASM._my_free(t),this.requestNextFrame()}initCanvas(){this.cvs.width=256,this.cvs.height=224}requestNextFrame(){this.WASM._setJoypadInput(this.keyInput),this.WASM._mainLoop();var a=this.WASM._getScreenBuffer(),t=new Uint8Array(this.WASM.HEAP8.buffer,a,ee);if(this.paintNewFrame(t),this.audioOn){let c=new Float32Array(this.WASM.HEAPF32.buffer,this.WASM._getSoundBuffer(),4096);this.audioNode.receiveAudio(c)}this.emulationRunning&&requestAnimationFrame(()=>this.requestNextFrame())}paintNewFrame(a){let t=new ImageData(ut,ft);for(var c=0;c<ee;c++)t.data[c]=a[c];this.ctx.putImageData(t,0,0,0,0,this.cvs.width,this.cvs.height)}pauseEmulation(){this.emulationRunning=!1}startEmulation(){this.emulationRunning=!0,this.requestNextFrame()}toggleEmulationRun(){this.emulationRunning?this.pauseEmulation():this.startEmulation()}saveState(){var a=this.WASM._getStateSaveSize(),t=this.WASM._saveState();if(t!=0){var c=new Uint8Array(new Uint8Array(this.WASM.HEAP8.buffer,t,a));return this.WASM._my_free(t),c}}loadState(a){var t=this.setUint8ArrayToCMemory(a);this.WASM._loadState(t,a.length),this.WASM._my_free(t)}loadRom(a){var t=this.setUint8ArrayToCMemory(a);this.WASM._startWithRom(t,a.length,O),this.WASM._my_free(t)}setVolume(a){this.audioNode.setVolume(a)}};var te=(s=>(s[s.A=128]="A",s[s.B=32768]="B",s[s.X=64]="X",s[s.Y=16384]="Y",s[s.SELECT=8192]="SELECT",s[s.START=4096]="START",s[s.L=32]="L",s[s.R=16]="R",s[s.RIGHT=256]="RIGHT",s[s.LEFT=512]="LEFT",s[s.DOWN=1024]="DOWN",s[s.UP=2048]="UP",s))(te||{}),ct={ArrowDown:1024,ArrowUp:2048,ArrowLeft:512,ArrowRight:256,a:128,b:32768,x:64,y:16384,o:4096,p:8192,l:32,r:16};function mt(v,a=ct){return{keydown:t=>{let c=t.key,m=a[c];m&&(v.keyInput=v.keyInput|m)},keyup:t=>{let c=t.key,m=a[c];m&&(v.keyInput=v.keyInput&(4294967295^m))}}}function vt(v){return(a,t=!0)=>{t?v.keyInput=v.keyInput|a:v.keyInput=v.keyInput&(4294967295^a)}}export{F as Emulator,te as SNES_CONTROL,vt as createInputHandle,mt as createKeyboardHandles};
